name: dev-e2e-no-compose

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  e2e-dev:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:7
        env:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: rootpass
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok'"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=30

    env:
      NODE_ENV: development
      PORT: 5000
      MONGODB_URI: mongodb://root:rootpass@localhost:27017/ci_db?authSource=admin
      JWT_ACCESS_SECRET: test-access-secret
      JWT_REFRESH_SECRET: test-refresh-secret
      ACCESS_TOKEN_TTL: 20s

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install jq and api deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          cd api && npm ci

      - name: Start API, wait, run tests, teardown
        run: |
          set -euo pipefail
          cd api
          node index.js > ../api.out 2>&1 & echo $! > ../api.pid
          cd ..
          # Wait for port 5000 to accept TCP (no healthcheck)
          for i in {1..120}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/)
            if [ "$code" != "000" ]; then break; fi
            sleep 2
          done
          if [ "$code" = "000" ]; then
            echo "API didn't open port 5000"; sed -n '1,300p' api.out || true; exit 1
          fi

          # Register (idempotent)
          curl -i -sS -X POST http://localhost:5000/api/register \
            -H "Content-Type: application/json" \
            -d '{"username":"ciuser","password":"cipass","isAdmin":false}' || true

          # Login (assert tokens)
          R=$(curl -sS -X POST http://localhost:5000/api/login \
            -H "Content-Type: application/json" \
            -d '{"username":"ciuser","password":"cipass"}')
          echo "$R" | jq -e '.accessToken,.refreshToken' >/dev/null
          AT=$(echo "$R" | jq -r '.accessToken')
          RT=$(echo "$R" | jq -r '.refreshToken')

          # Refresh -> new tokens
          R=$(curl -sS -X POST http://localhost:5000/api/refresh \
            -H "Content-Type: application/json" \
            -d "{\"token\":\"${RT}\"}")
          echo "$R" | jq -e '.accessToken,.refreshToken' >/dev/null
          NAT=$(echo "$R" | jq -r '.accessToken')
          NRT=$(echo "$R" | jq -r '.refreshToken')
          test "$NAT" != "$AT"
          test "$NRT" != "$RT"

          # Logout invalidates old refresh
          curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:5000/api/logout \
            -H "Content-Type: application/json" \
            -d "{\"token\":\"${RT}\"}" | grep -q "^200$"
          curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:5000/api/refresh \
            -H "Content-Type: application/json" \
            -d "{\"token\":\"${RT}\"}" | grep -q "^403$"

        shell: bash

      - name: Print API log on failure
        if: failure()
        run: sed -n '1,300p' api.out || true

      - name: Teardown API
        if: always()
        run: kill $(cat api.pid) 2>/dev/null || true
